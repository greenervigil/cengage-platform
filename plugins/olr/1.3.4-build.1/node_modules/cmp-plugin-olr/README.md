# OLR Plugin

The OLR plugin is the primary integration for connecting CMP sessions to the OLR service.  With it, you'll be able to secure URL paths as well as ensure the headers related to the session are passed along to your proxy endpoints every time.

This plugin is an extension of the [Authentication](http://stash.corp.web:7990/projects/CMP/repos/cmp-plugin-authentication/browse) plugin.

This plugin depends on a session created first via the [SSO](http://stash.corp.web:7990/projects/CMP/repos/cmp-plugin-sso/browse) plugin.

When a request is made through CMP, where this plugin is enabled, a session is active, and a `courseKey` or `courseCgi` query parameter is present, a call to OLR will be made to populate the session data and inject the headers configured.

## Properties

| property       | type            | description                                                                                                                                                             |
|----------------|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `endpoint`      | `string`       | The HTTP endpoint used for REST calls to the OLR service.  This should just be the hostname with appropriate protocol. |
| `headerPrefix`      | `string` | The prefix used at the beginning of every header key.  Defaults to `cengage-sso`. |
| `mode`      | `string` | Defines how to act on a given request. `allow` will pass through any request regardless of authentication. `restrict` will simply throw a 401 if not authenticated. |
| `mappings`      | `object` | Collection of types of mappings supported.  |
| `mappings.authResponse`      | `object` | Key/Value pairs.  The key will be used to generate the header `${headerPrefix}-${key}`.  The value is used to pull the data from the OLR response. |
| `mappings.requestParams`      | `array` | The key will be used to generate the header `cmp-dynamic-${key}`.  The value is pulled from the matching queryParam if it exists. |



## Usage

```
{
  "plugins":{
    "sso":{
      "endpoint":"http://s-ws-i.cengage.com",
      "login":"https://s-login.cengagebrain.com/cb/login.htm",
      "mappings":{
        "requestParams:[
          "eISBN", "titleIsbn", "courseKey", "ctx", "ILRN_CODE", "courseCgi"
        ],
        "authResponse":{
          "guid": "data.entitlement.guid",
          "role": "entitlementProduct.enrollmentType",
          "cgi": "entitlementProduct.cgi",
          "institution": "data.entitlement.institutionName",
          "institution-id": "data.entitlement.cnowInstitutionId"
        }
      }
    }
  }
}
```

## authResponse

To help you understand how the `authResponse` mappings work, we build up an object containing the following values:

```
{
  data: authData,
  entitlementProduct: processedData
}
```

If there is an `eISBN` specified in the request, we will also create a `token` property on the above object:

```
{
  data: authData,
  entitlementProduct: processedData,
  title: _.get(authData, 'entitlement.titles.title[processedData.titleKey]', {})
}
```

`processedData` is the raw data sent back from the OLR service.  Using the raw data, as well as understanding of the above object, you should be able to create your own mappings within `authResponse`.

Keep in mind, we do support pipes in the mappings, incase you want to have a fallback:

```
"first-name":"user.givenName|user.firstName"
```


## Example Working Policy

```
{
  "guid": "basic-sso-olr-policy",
  "host": "localhost",
  "plugins": {
    "sso": {
      "mode": "redirect",
      "intended": "true",
      "endpoint": "https://d-ws.cengage.com",
      "login": "https://d-login.cengage.com/cb/login.htm"
    },
    "olr": {
      "endpoint": "https://d-ws.cengage.com"
    }
  },
  "paths": {
    "/": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo",
      "plugins": {
        "sso": {
          "mode": "allow"
        }
      }
    },
    "/api": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo"
    },
    "/homepage": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo"
    }
  }
}

```

With this above policy, access to the `/homepage` endpoint will be redirected to login if no session is currently active.

Access to the `/api` endpoint will throw a 401 if no session is currently active.

Access to the `/` path and any other path not beginning with `/api` or `/homepage` will allow unauthenticated users through.