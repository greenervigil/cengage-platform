var chai = require('chai'),
    fs = require('fs'),
    request = require('request'),
    sinon = require("sinon"),
    sinonChai = require("sinon-chai"),
    expect = chai.expect;

var agService;

describe('lib/repos/agService.js', function() {

    before(function() {
        agService = require('../../lib/repos/agService');
        chai.use(sinonChai);
    });

    after(function() {
        request.post.restore();
        fs.createReadStream.restore();
    });

    it('Upload rejects when upload of tarball fails', function(done) {
        sinon.stub(request, 'post', function(url, callback) {
            callback(null, {'statusCode':300});
        });

        sinon.stub(fs, 'createReadStream', function() {
            return {
                pipe: function() {},
                on: function() {}
            }
        });

        agService.upload("TestName", "testVersion", __dirname + "/../../integration/src/small_file").catch(function(){ done() });
    });
});