# CMP Plugin: Cengage Trace Phrase

## Purpose

When communicating from a front-end system to a SOA back-end based, [Omnibus](http://stash.corp.web:7990/projects/SOCOM/repos/logging-utils/browse/jaxrs/src/main/java/com/cengage/socom/logging/jaxrs/ContainerTracePhraseFilter.java)
will inspect the HTTP header named `cengage_trace_phrase` and add its value to the [MDC](https://logback.qos.ch/manual/mdc.html).
This value can then be included in SOA log files for the purpose of tracing a call from the front-end to various back-end services.

## Properties

| property       | type            | description                                                                                                                                                             |
|----------------|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `enabled`      | `boolean`       | Enables or disables this plugin for a path                                                                                                                              |
| `ignored`      | `array[string]` | A list of paths that this plugin will ignore                                                                                                                            |
| `sessionAware` | `boolean`       | Given two requests with the same `cmp-session-id`, if this property is set, the trace phrase header will remain the same                                                |
| `headerName`   | `string`        | Allows you to change the default trace phrase header name from `cengage_trace_phrase`                                                                                   |
| `sharedPhrase` | `boolean`       | If `sessionAware` and `headerName` is set, setting this property will ensure the same trace phrase is used across various header names for requests in the same session |

## Usage

**Note:** this plugin works with CMP release 5.1.x or higher, previous versions would not allow a header to be sent
without a `x-cmp` prefix

To use this plugin, add it's configuration to your policy file, for example:

```
{
    "guid": "cengage-trace-phrase-0001",
    "host": "localhost",
    "plugins": {
      "trace-phrase": {
        "enabled": true,
        "sessionAware": true,
        "version": "1.0.3-build.1"
      }
    },
    "paths": {
        "/": {
            "url": "http://127.0.0.1:3000/",
            "plugins": {
                "trace-phrase": {
                    "enabled": false
                }
            }
        },
        "/noSession": {
            "url": "http://127.0.0.1:3000/",
            "plugins": {
                "trace-phrase": {
                    "sessionAware": false
                }
            }
        },
        "/sessionAware": {
            "url": "http://127.0.0.1:3000/",
            "plugins": {
                "trace-phrase": {
                    "sessionAware": true
                }
            }
        },
        "/diffHeader": {
            "url": "http://127.0.0.1:3000/",
            "plugins": {
                "trace-phrase": {
                    "headerName": "a_different_header_name"
                }
            }
        },
        "/diffHeaderSharedPhrase": {
            "url": "http://127.0.0.1:3000/",
            "plugins": {
                "trace-phrase": {
                    "headerName": "a_different_header_name",
                    "sessionAware": true,
                    "sharedPhrase": true
                }
            }
        }

    }

```

This would result in request to:

| path                      | description                                                                                                                                                                                                                                                              |
|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `/`                       | No `cengage_trace_phrase` will be created as the plugin is disabled                                                                                                                                                                                                      |
| `/noSession`              | A different `cengage_trace_phrase` header will be generated for every request                                                                                                                                                                                            |
| `/sessionAware`           | Requests with the same `cmp-session-id` header/cookie, will cause the trace phrase header value to remain the same                                                                                                                                                       |
| `/diffHeader`             | Default trace phrase header will be `a_different_header_name` instead of  `cengage_trace_phrase`                                                                                                                                                                         |
| `/diffHeaderSharedPhrase` | The same trace phrase is used across various header names for requests in the same session. For instance a request to `/sessionAware` will generate the same value for `cengage_trace_phrase` as a call to `/diffHeaderSharedPhrase`'s `a_different_header_name` header  |

## Result

Given the example usage above, a call to `/mySoaApi` without a `cengage_trace_phrase` header being present would result
in a `cengage_trace_phrase` header being generated and added to the request, made up of a unique 3-word phrase.

And now this front-end request to the `/mySoaApi` can be traced through the back-end logs (if the `cengage_trace_phrase` MDC
is being logged)
