# SSO Plugin

The SSO plugin is the primary integration for connecting CMP sessions to the SSO service.  With it, you'll be able to secure URL paths as well as ensure the headers related to the session are passed along to your proxy endpoints every time.

This plugin is an extension of the [Authentication](http://stash.corp.web:7990/projects/CMP/repos/cmp-plugin-authentication/browse) plugin.

When a request is made through CMP, where this plugin is enabled, and a `token` query parameter is present, a call to SSO will be made to populate the session data and inject the headers configured.

## Properties

| property       | type            | description                                                                                                                                                             |
|----------------|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `endpoint`      | `string`       | The HTTP endpoint used for REST calls to the SSO service.  This should just be the hostname with appropriate protocol. |
| `login`      | `string` | The path to the login page for initializing the session. |
| `intended`      | `boolean` | If a user is forced to the login page, setting this attribute to true will return the user to where they came from.  If not specified, it's recommended to specify a `targeturl` query parameter on the `login` path. |
| `headerPrefix`      | `string` | The prefix used at the beginning of every header key.  Defaults to `cengage-sso`. |
| `mode`      | `string` | Defines how to act on a given request. `allow` will pass through any request regardless of authentication. `restrict` will simply throw a 401 if not authenticated. `redirect` will send the user to the specified `login` page. |
| `mappings`      | `object` | Collection of types of mappings supported.  Currently, only `authResponse` is available for the SSO plugin. |
| `mappings.authResponse`      | `object` | Key/Value pairs.  The key will be used to generate the header `${headerPrefix}-${key}`.  The value is used to pull the data from the SSO response. |



## Usage

```
{
  "plugins":{
    "sso":{
      "endpoint":"http://s-ws-i.cengage.com",
      "login":"https://s-login.cengagebrain.com/cb/login.htm",
      "mappings":{
        "authResponse":{
          "guid":"data.guid",
          "role":"data.userType",
          "first-name":"user.givenName",
          "last-name":"user.sn",
          "email":"user.mail",
          "institution":"user.tlinstitutionName",
          "institution-id":"user.tlinstitutionId"
        }
      }
    }
  }
}
```

## authResponse

To help you understand how the `authResponse` mappings work, we build up an object containing the following values:

```
{
  token: authData.token,
  data: authData,
  expiration: expiration,
  user: _.get(authData, 'users.tlperson[0]')
}
```

`authData` is the raw data sent back from the SSO service.  Using the raw data, as well as understanding of the above object, you should be able to create your own mappings within `authResponse`.

Keep in mind, we do support pipes in the mappings, incase you want to have a fallback:

```
"first-name":"user.givenName|user.firstName"
```


## Example Working Policy

```
{
  "guid": "basic-sso-policy",
  "host": "localhost",
  "plugins": {
    "sso": {
      "mode": "redirect",
      "intended": "true",
      "endpoint": "https://d-ws.cengage.com",
      "login": "https://d-login.cengage.com/cb/login.htm"
    }
  },
  "paths": {
    "/": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo",
      "plugins": {
        "sso": {
          "mode": "allow"
        }
      }
    },
    "/api": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo"
    },
    "/homepage": {
      "url": "http://eitstatic-server01.test.cengage.info:8080/echo"
    }
  }
}

```

With this above policy, access to the `/homepage` endpoint will be redirected to login if no session is currently active.

Access to the `/api` endpoint will throw a 401 if no session is currently active.

Access to the `/` path and any other path not beginning with `/api` or `/homepage` will allow unauthenticated users through.


## Session Management
By default, an SSO session is good for 60 minutes.  CMP will automatically attempt to refresh the session if a request for the valid session is passed through during the last 20% of the session (minutes 48-60).  CMP can also be told to refresh progmatically by having the backend service attach a `cengage-sso-refresh: true` header key/value pairing on the response object.